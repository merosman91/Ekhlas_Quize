<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدرسة الإخلاص - التعليم المتميز</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* إضافة أنماط جديدة للتحسينات */
        
        /* تحسينات عامة */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* تحسينات على شريط التقدم */
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .question-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-light);
            border: 2px solid var(--border-color);
        }
        
        .question-indicator.answered {
            background: var(--light-color);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .question-indicator.current {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .question-indicator.marked {
            position: relative;
        }
        
        .question-indicator.marked::after {
            content: "!";
            position: absolute;
            top: -5px;
            left: -5px;
            width: 18px;
            height: 18px;
            background: var(--warning-color);
            border-radius: 50%;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* تحسينات على شاشة النتائج */
        .result-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .result-message.good {
            background: rgba(59, 130, 246, 0.1);
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }
        
        .result-message.average {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }
        
        .result-message.poor {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }
        
        /* تحسينات على شاشة الاختبار */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .mark-btn {
            background: transparent;
            border: 2px solid var(--warning-color);
            color: var(--warning-color);
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .mark-btn:hover, .mark-btn.active {
            background: var(--warning-color);
            color: white;
        }
        
        /* تحسينات على الإشعارات */
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
        }
        
        .notification i {
            font-size: 1.2rem;
        }
        
        /* تحسينات على شاشة البداية */
        .subject-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .subject-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .subject-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
        }
        
        .subject-option.selected {
            background: var(--light-color);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .subject-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        /* تحسينات على الشاشات الصغيرة */
        @media (max-width: 768px) {
            .questions-grid {
                grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
                gap: 5px;
            }
            
            .question-indicator {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .quiz-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .subject-options {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        
        /* تحسينات على شاشة النتائج */
        .result-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        /* تحسينات على التنقل */
        .scroll-top {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 99;
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        
        .scroll-top.show {
            opacity: 1;
            visibility: visible;
        }
        
        .scroll-top:hover {
            background: var(--dark-color);
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <!-- Navigation (لا تغيير) -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span class="logo-text">مدرسة الإخلاص</span>
            </div>
            <ul class="nav-menu">
                <li><a href="#home" class="nav-link">الرئيسية</a></li>
                <li><a href="#about" class="nav-link">من نحن</a></li>
                <li><a href="#quiz" class="nav-link">الاختبارات</a></li>
                <li><a href="#contact" class="nav-link">اتصل بنا</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Hero Section (لا تغيير) -->
    <section id="home" class="hero">
        <div class="hero-content">
            <h1 class="hero-title">مرحباً بك في مدرسة الإخلاص</h1>
            <p class="hero-subtitle">مؤسسة تعليمية رائدة تقدم تعليماً متميزاً لجميع المراحل الدراسية</p>
            <div class="hero-buttons">
                <button onclick="scrollToSection('quiz')" class="btn btn-primary">
                    <i class="fas fa-play"></i> ابدأ الاختبار الآن
                </button>
                <button onclick="scrollToSection('about')" class="btn btn-secondary">
                    <i class="fas fa-info-circle"></i> اعرف المزيد
                </button>
            </div>
        </div>
    </section>

    <!-- About Section (لا تغيير) -->
    <section id="about" class="about">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">من نحن</h2>
                <div class="section-divider"></div>
            </div>
            <div class="about-content">
                <p class="about-description">
                    مدرسة الإخلاص هي مؤسسة تعليمية سودانية رائدة تأسست عام 2000، وتتميز بتقديم تعليم عالي الجودة
                    يتوافق مع المناهج السودانية المعتمدة من وزارة التربية والتعليم.
                </p>
                <p class="about-description">
                    نحن نؤمن بأهمية التعليم الشامل الذي يركز على الجوانب الأكاديمية والاجتماعية والنفسية للطلاب،
                    ونسعى لإعداد جيل قادر على مواجهة تحديات المستقبل بثقة وكفاءة.
                </p>
            </div>
        </div>
    </section>

    <!-- Quiz Section (مع تحسينات) -->
    <section id="quiz" class="quiz-section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">الاختبارات التفاعلية</h2>
                <div class="section-divider"></div>
            </div>
            
            <div id="quiz-setup" class="quiz-setup">
                <div class="quiz-form">
                    <div class="form-group">
                        <label for="stage">المرحلة الدراسية</label>
                        <select id="stage" class="form-control">
                            <option value="">اختر المرحلة</option>
                            <option value="primary">المرحلة الابتدائية</option>
                            <option value="middle">المرحلة المتوسطة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="subject">المادة الدراسية</label>
                        <div class="subject-options" id="subject-options">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="difficulty">درجة الصعوبة</label>
                        <select id="difficulty" class="form-control">
                            <option value="easy">سهل</option>
                            <option value="medium" selected>متوسط</option>
                            <option value="hard">صعب</option>
                        </select>
                    </div>
                    
                    <button onclick="startQuiz()" class="btn btn-primary" id="start-btn">
                        <i class="fas fa-play"></i> بدء الاختبار
                    </button>
                </div>
            </div>
            
            <div id="quiz-container" class="quiz-container">
                <div class="quiz-header">
                    <div class="quiz-info">
                        <span id="quiz-progress">1/10</span>
                        <span id="quiz-timer">00:00</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                </div>
                
                <div class="quiz-body">
                    <div class="quiz-controls">
                        <div class="questions-grid" id="questions-grid">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                        <button class="mark-btn" id="mark-btn" onclick="toggleMarkQuestion()">
                            <i class="fas fa-flag"></i> وضع علامة للمراجعة
                        </button>
                    </div>
                    
                    <div id="question-container" class="question-container">
                        <!-- Question will be loaded here -->
                    </div>
                </div>
                
                <div class="quiz-footer">
                    <button onclick="previousQuestion()" class="btn btn-secondary" id="prev-btn" disabled>
                        <i class="fas fa-arrow-right"></i> السؤال السابق
                    </button>
                    <button onclick="nextQuestion()" class="btn btn-primary" id="next-btn">
                        السؤال التالي <i class="fas fa-arrow-left"></i>
                    </button>
                    <button onclick="submitQuiz()" class="btn btn-success" id="submit-btn" style="display: none;">
                        <i class="fas fa-check"></i> إنهاء الاختبار
                    </button>
                </div>
            </div>
            
            <div id="quiz-result" class="quiz-result">
                <div class="result-content">
                    <div class="result-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h2 class="result-title">نتيجة الاختبار</h2>
                    <div class="result-score">
                        <span id="score-percentage">0%</span>
                    </div>
                    <div class="result-details">
                        <div class="detail-item">
                            <span>الإجابات الصحيحة:</span>
                            <span id="correct-answers">0</span>
                        </div>
                        <div class="detail-item">
                            <span>الإجابات الخاطئة:</span>
                            <span id="wrong-answers">0</span>
                        </div>
                        <div class="detail-item">
                            <span>المدة الزمنية:</span>
                            <span id="time-taken">00:00</span>
                        </div>
                    </div>
                    <div class="result-message" id="result-message">
                        <!-- Message will be displayed here -->
                    </div>
                    <div class="result-actions">
                        <button onclick="resetQuiz()" class="btn btn-primary">
                            <i class="fas fa-redo"></i> اختبار جديد
                        </button>
                        <button onclick="reviewQuiz()" class="btn btn-secondary" id="review-btn">
                            <i class="fas fa-eye"></i> مراجعة الإجابات
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer (لا تغيير) -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <div class="logo-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <span class="logo-text">مدرسة الإخلاص</span>
                    </div>
                    <p class="footer-description">
                        مؤسسة تعليمية رائدة تقدم تعليماً متميزاً لجميع المراحل الدراسية
                    </p>
                </div>
                <div class="footer-section">
                    <h3 class="footer-title">روابط سريعة</h3>
                    <ul class="footer-links">
                        <li><a href="#home">الرئيسية</a></li>
                        <li><a href="#about">من نحن</a></li>
                        <li><a href="#quiz">الاختبارات</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 مدرسة الإخلاص. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <!-- زر العودة للأعلى -->
    <div class="scroll-top" id="scroll-top" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </div>

    <script>
        // ===================================
        // 1. DATABASE (Question Bank) - نفس السابق
        // ===================================
        const questionBank = {
            // ... (نفس قاعدة الأسئلة السابقة)
        };

        // ===================================
        // 2. QUIZ LOGIC مع التحسينات
        // ===================================
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timer;
        let seconds = 0;
        let selectedAnswers = [];
        let markedQuestions = [];
        let quizStarted = false;

        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Quiz script: DOM is ready.");

            const stageSelect = document.getElementById('stage');
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');

            if (!stageSelect) {
                console.error("Quiz Error: Could not find stage select element.");
                return;
            }

            // Event Listeners
            stageSelect.addEventListener('change', handleStageChange);
            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                navMenu.classList.toggle('active');
            });
            
            // Close mobile menu when clicking on a link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    hamburger.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            });

            // إضافة مستمع لحدث التمرير لإظهار/إخفاء زر العودة للأعلى
            window.addEventListener('scroll', toggleScrollTopButton);
            
            // محاولة استعادة الاختبار المحفوظ
            restoreQuizProgress();
            
            console.log("Quiz script: Initialized successfully.");
        });

        function handleStageChange() {
            const selectedStage = this.value;
            const subjectOptions = document.getElementById('subject-options');
            
            subjectOptions.innerHTML = '';
            
            if (!selectedStage) return;

            try {
                if (!questionBank || !questionBank[selectedStage]) {
                    throw new Error(`Stage "${selectedStage}" not found.`);
                }

                const subjects = Object.keys(questionBank[selectedStage]);
                if (subjects.length === 0) {
                    throw new Error(`No subjects found for stage "${selectedStage}".`);
                }

                subjects.forEach(subject => {
                    const option = document.createElement('div');
                    option.className = 'subject-option';
                    option.setAttribute('data-value', subject);
                    option.innerHTML = `
                        <div class="subject-icon">
                            <i class="${getSubjectIcon(subject)}"></i>
                        </div>
                        <div class="subject-name">${getSubjectArabicName(subject)}</div>
                    `;
                    option.addEventListener('click', () => selectSubject(subject));
                    subjectOptions.appendChild(option);
                });

                console.log(`Subjects populated for stage: ${selectedStage}`);

            } catch (error) {
                console.error("Failed to populate subjects:", error);
                showNotification('حدث خطأ أثناء تحميل المواد', 'error');
            }
        }

        function selectSubject(subject) {
            // إزالة التحديد من جميع الخيارات
            document.querySelectorAll('.subject-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // إضافة التحديد للخيار المختار
            const selectedOption = document.querySelector(`.subject-option[data-value="${subject}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
        }

        function getSubjectIcon(subject) {
            const icons = {
                mathematics: 'fas fa-calculator',
                arabic: 'fas fa-book',
                english: 'fas fa-language',
                science: 'fas fa-flask',
                physics: 'fas fa-atom',
                chemistry: 'fas fa-vial',
                biology: 'fas fa-dna'
            };
            return icons[subject] || 'fas fa-book';
        }

        function getSubjectArabicName(subject) {
            const names = {
                mathematics: 'الرياضيات', 
                arabic: 'اللغة العربية', 
                english: 'اللغة الإنجليزية',
                science: 'العلوم', 
                history: 'التاريخ', 
                geography: 'الجغرافيا',
                religious_studies: 'التربية الإسلامية', 
                physics: 'الفيزياء',
                chemistry: 'الكيمياء', 
                biology: 'الأحياء'
            };
            return names[subject] || subject;
        }

        function startQuiz() {
            const stage = document.getElementById('stage').value;
            const selectedSubject = document.querySelector('.subject-option.selected');
            const difficulty = document.getElementById('difficulty').value;

            if (!stage || !selectedSubject) {
                showNotification('الرجاء اختيار المرحلة والمادة', 'error');
                return;
            }

            const subject = selectedSubject.getAttribute('data-value');
            
            // إضافة مؤشر تحميل
            const startBtn = document.getElementById('start-btn');
            const originalText = startBtn.innerHTML;
            startBtn.innerHTML = '<span class="loading"></span> جاري التحميل...';
            startBtn.disabled = true;

            try {
                const questions = [...questionBank[stage][subject][difficulty]];
                if (questions.length === 0) {
                    throw new Error('No questions found for the selected criteria.');
                }

                // محاكاة وقت التحميل لتحسين تجربة المستخدم
                setTimeout(() => {
                    currentQuiz = shuffleArray(questions).slice(0, 10);
                    currentQuestionIndex = 0;
                    score = 0;
                    seconds = 0;
                    selectedAnswers = [];
                    markedQuestions = [];
                    quizStarted = true;

                    document.getElementById('quiz-setup').style.display = 'none';
                    document.getElementById('quiz-container').style.display = 'block';
                    document.getElementById('quiz-result').style.display = 'none';

                    createQuestionIndicators();
                    loadQuestion();
                    startTimer();
                    
                    // حفظ تقدم الاختبار
                    saveQuizProgress();

                    // إعادة تعيين زر البدء
                    startBtn.innerHTML = originalText;
                    startBtn.disabled = false;
                    
                    showNotification('تم بدء الاختبار بنجاح!', 'success');
                }, 1000);

            } catch (error) {
                console.error("Failed to start quiz:", error);
                showNotification('لا توجد أسئلة متاحة لهذا الاختيار', 'error');
                
                // إعادة تعيين زر البدء في حالة الخطأ
                startBtn.innerHTML = originalText;
                startBtn.disabled = false;
            }
        }

        function createQuestionIndicators() {
            const questionsGrid = document.getElementById('questions-grid');
            questionsGrid.innerHTML = '';
            
            for (let i = 0; i < currentQuiz.length; i++) {
                const indicator = document.createElement('div');
                indicator.className = 'question-indicator';
                indicator.textContent = i + 1;
                indicator.addEventListener('click', () => navigateToQuestion(i));
                questionsGrid.appendChild(indicator);
            }
            
            updateQuestionIndicators();
        }

        function updateQuestionIndicators() {
            const indicators = document.querySelectorAll('.question-indicator');
            
            indicators.forEach((indicator, index) => {
                indicator.classList.remove('current', 'answered', 'marked');
                
                if (index === currentQuestionIndex) {
                    indicator.classList.add('current');
                }
                
                if (selectedAnswers[index] !== undefined) {
                    indicator.classList.add('answered');
                }
                
                if (markedQuestions.includes(index)) {
                    indicator.classList.add('marked');
                }
            });
        }

        function navigateToQuestion(index) {
            if (index >= 0 && index < currentQuiz.length) {
                currentQuestionIndex = index;
                loadQuestion();
            }
        }

        function toggleMarkQuestion() {
            const index = markedQuestions.indexOf(currentQuestionIndex);
            
            if (index === -1) {
                markedQuestions.push(currentQuestionIndex);
                document.getElementById('mark-btn').classList.add('active');
                showNotification('تم وضع علامة على السؤال للمراجعة', 'info');
            } else {
                markedQuestions.splice(index, 1);
                document.getElementById('mark-btn').classList.remove('active');
                showNotification('تم إزالة العلامة من السؤال', 'info');
            }
            
            updateQuestionIndicators();
            saveQuizProgress();
        }

        function loadQuestion() {
            const question = currentQuiz[currentQuestionIndex];
            const questionContainer = document.getElementById('question-container');
            
            questionContainer.innerHTML = `
                <div class="question-text">${question.question}</div>
                <div class="options-grid">
                    ${question.options.map((option, index) => `
                        <div class="option-item ${selectedAnswers[currentQuestionIndex] === index ? 'selected' : ''}" onclick="selectAnswer(${index})">
                            <span class="option-text">${option}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // تحديث زر وضع العلامة
            const markBtn = document.getElementById('mark-btn');
            if (markedQuestions.includes(currentQuestionIndex)) {
                markBtn.classList.add('active');
                markBtn.innerHTML = '<i class="fas fa-flag"></i> إزالة العلامة';
            } else {
                markBtn.classList.remove('active');
                markBtn.innerHTML = '<i class="fas fa-flag"></i> وضع علامة للمراجعة';
            }

            updateProgress();
            updateButtons();
            updateQuestionIndicators();
            saveQuizProgress();
        }

        function selectAnswer(answerIndex) {
            const options = document.querySelectorAll('.option-item');
            options.forEach(option => option.classList.remove('selected'));
            options[answerIndex].classList.add('selected');
            selectedAnswers[currentQuestionIndex] = answerIndex;
            
            updateQuestionIndicators();
            saveQuizProgress();
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                submitQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function submitQuiz() {
            if (selectedAnswers.length < currentQuiz.length) {
                const confirmSubmit = confirm("لم تجب على جميع الأسئلة. هل أنت متأكد من إنهاء الاختبار؟");
                if (!confirmSubmit) return;
            }
            
            stopTimer();
            score = 0;
            currentQuiz.forEach((question, index) => {
                if (selectedAnswers[index] === question.correct) {
                    score++;
                }
            });
            showResults();
            clearQuizProgress();
        }

        function showResults() {
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('quiz-result').style.display = 'block';

            const percentage = Math.round((score / currentQuiz.length) * 100);
            const correctAnswers = score;
            const wrongAnswers = currentQuiz.length - score;
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;

            document.getElementById('score-percentage').textContent = percentage + '%';
            document.getElementById('correct-answers').textContent = correctAnswers;
            document.getElementById('wrong-answers').textContent = wrongAnswers;
            document.getElementById('time-taken').textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            const resultScore = document.querySelector('.result-score');
            if(resultScore) {
                resultScore.style.background = `conic-gradient(var(--success-color) ${percentage * 3.6}deg, var(--light-color) 0deg)`;
            }

            const messageEl = document.getElementById('result-message');
            let message, messageClass;
            if (percentage >= 90) { 
                message = 'ممتاز! أداء رائع جداً!'; 
                messageClass = 'success'; 
            }
            else if (percentage >= 70) { 
                message = 'جيد جداً! واصل التميز!'; 
                messageClass = 'good'; 
            }
            else if (percentage >= 50) { 
                message = 'جيد! يمكنك التحسن أكثر!'; 
                messageClass = 'average'; 
            }
            else { 
                message = 'تحتاج للمزيد من الدراسة والممارسة!'; 
                messageClass = 'poor'; 
            }

            messageEl.textContent = message;
            messageEl.className = 'result-message ' + messageClass;
            
            // إظهار زر المراجعة فقط إذا كان هناك أخطاء
            if (wrongAnswers > 0) {
                document.getElementById('review-btn').style.display = 'block';
            } else {
                document.getElementById('review-btn').style.display = 'none';
            }
        }

        function reviewQuiz() {
            // في النسخة الكاملة، يمكن تنفيذ شاشة مراجعة مفصلة
            alert("في النسخة الكاملة، سيتم عرض شاشة مراجعة مفصلة للإجابات الصحيحة والخاطئة.");
        }

        function resetQuiz() {
            document.getElementById('quiz-result').style.display = 'none';
            document.getElementById('quiz-setup').style.display = 'block';
            document.getElementById('stage').value = '';
            document.querySelectorAll('.subject-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById('difficulty').value = 'medium';
            currentQuiz = []; 
            currentQuestionIndex = 0; 
            score = 0; 
            seconds = 0; 
            selectedAnswers = [];
            markedQuestions = [];
            quizStarted = false;
            clearQuizProgress();
        }

        // ===================================
        // 3. نظام حفظ التقدم
        // ===================================
        function saveQuizProgress() {
            if (!quizStarted) return;
            
            const progress = {
                currentQuiz,
                currentQuestionIndex,
                score,
                seconds,
                selectedAnswers,
                markedQuestions,
                timestamp: Date.now()
            };
            
            localStorage.setItem('quizProgress', JSON.stringify(progress));
        }

        function restoreQuizProgress() {
            const savedProgress = localStorage.getItem('quizProgress');
            
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    const timeDiff = Date.now() - progress.timestamp;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    
                    // استعادة التقدم فقط إذا مر أقل من ساعة
                    if (hoursDiff < 1) {
                        const resume = confirm("يوجد اختبار غير مكتمل. هل تريد استئنافه؟");
                        
                        if (resume) {
                            currentQuiz = progress.currentQuiz;
                            currentQuestionIndex = progress.currentQuestionIndex;
                            score = progress.score;
                            seconds = progress.seconds;
                            selectedAnswers = progress.selectedAnswers;
                            markedQuestions = progress.markedQuestions;
                            quizStarted = true;

                            document.getElementById('quiz-setup').style.display = 'none';
                            document.getElementById('quiz-container').style.display = 'block';
                            document.getElementById('quiz-result').style.display = 'none';

                            createQuestionIndicators();
                            loadQuestion();
                            startTimer();
                            
                            showNotification('تم استئناف الاختبار', 'info');
                        } else {
                            clearQuizProgress();
                        }
                    } else {
                        clearQuizProgress();
                    }
                } catch (e) {
                    console.error("Error restoring quiz progress:", e);
                    clearQuizProgress();
                }
            }
        }

        function clearQuizProgress() {
            localStorage.removeItem('quizProgress');
        }

        // ===================================
        // 4. دوال مساعدة محسنة
        // ===================================
        function shuffleArray(array) { 
            for (let i = array.length - 1; i > 0; i--) { 
                const j = Math.floor(Math.random() * (i + 1)); 
                [array[i], array[j]] = [array[j], array[i]]; 
            } 
            return array; 
        }
        
        function updateProgress() { 
            const progress = ((currentQuestionIndex + 1) / currentQuiz.length) * 100; 
            document.getElementById('progress-fill').style.width = progress + '%'; 
            document.getElementById('quiz-progress').textContent = `${currentQuestionIndex + 1}/${currentQuiz.length}`; 
        }
        
        function updateButtons() { 
            const prevBtn = document.getElementById('prev-btn'); 
            const nextBtn = document.getElementById('next-btn'); 
            const submitBtn = document.getElementById('submit-btn'); 
            prevBtn.disabled = currentQuestionIndex === 0; 
            if (currentQuestionIndex === currentQuiz.length - 1) { 
                nextBtn.style.display = 'none'; 
                submitBtn.style.display = 'block'; 
            } else { 
                nextBtn.style.display = 'block'; 
                submitBtn.style.display = 'none'; 
            } 
        }
        
        function startTimer() { 
            timer = setInterval(() => { 
                seconds++; 
                const mins = Math.floor(seconds / 60); 
                const secs = seconds % 60; 
                document.getElementById('quiz-timer').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`; 
            }, 1000); 
        }
        
        function stopTimer() { 
            clearInterval(timer); 
        }
        
        function showNotification(message, type = 'info') { 
            // إغلاق أي إشعارات سابقة
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            });
            
            const notification = document.createElement('div'); 
            notification.className = `notification notification-${type}`; 
            
            const icons = {
                'error': 'fas fa-exclamation-circle',
                'success': 'fas fa-check-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="${icons[type] || icons['info']}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification); 
            setTimeout(() => { 
                notification.style.animation = 'slideUp 0.3s ease'; 
                setTimeout(() => { 
                    if (document.body.contains(notification)) document.body.removeChild(notification); 
                }, 300); 
            }, 4000); 
        }

        // ===================================
        // 5. دوال التنقل والتحسينات العامة
        // ===================================
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function toggleScrollTopButton() {
            const scrollTopBtn = document.getElementById('scroll-top');
            if (window.scrollY > 300) {
                scrollTopBtn.classList.add('show');
            } else {
                scrollTopBtn.classList.remove('show');
            }
        }
    </script>
</body>
  </html> 
